name: Build and Release Kaitu

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            name: macos
            targets: universal-apple-darwin,x86_64-apple-darwin,aarch64-apple-darwin
          # - os: windows-latest
          #   name: windows
          #   targets: x86_64-pc-windows-msvc
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Get version first
        id: get-version-early
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Checkout Kaitu repository
        uses: actions/checkout@v4
        with:
          repository: allnationconnect/kaitu
          ref: v${{ steps.get-version-early.outputs.VERSION }}
          path: kaitu
          token: ${{ secrets.GH_PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: 'kaitu/client/desktop/yarn.lock'
      
      - name: Cache yarn dependencies
        uses: actions/cache@v4
        id: yarn-cache
        with:
          path: |
            ~/.yarn/cache
            kaitu/client/desktop/node_modules
            kaitu/client/desktop/.yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('kaitu/client/desktop/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust targets (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Add Rust targets (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          rustup target add x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            kaitu/client/desktop/src-tauri -> target
          cache-on-failure: true
          save-if: true
          shared-key: ${{ matrix.os }}-rust-cache
          
      - name: Cache Rust registry and git dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('kaitu/client/desktop/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true
          cache-dependency-path: kaitu/go.sum
          
      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('kaitu/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Verify version
        id: get-version
        shell: bash
        working-directory: kaitu
        run: |
          # Use the version we already got
          VERSION="${{ steps.get-version-early.outputs.VERSION }}"
          # Verify it matches the package.json
          PACKAGE_VERSION=$(node -p "require('./client/desktop/package.json').version")
          if [[ "${VERSION}" != "${PACKAGE_VERSION}" ]]; then
            echo "‚ö†Ô∏è Warning: Tag version ${VERSION} doesn't match package.json version ${PACKAGE_VERSION}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Install dependencies
        working-directory: kaitu/client/desktop
        run: |
          if [[ "${{ steps.yarn-cache.outputs.cache-hit }}" == "true" ]]; then
            echo "‚úÖ Cache hit! Skipping yarn install"
            echo "Verifying node_modules exists..."
            if [ -d "node_modules" ]; then
              echo "‚úÖ node_modules directory found"
            else
              echo "‚ùå node_modules not found, running yarn install"
              yarn install --frozen-lockfile
            fi
          else
            echo "‚ùå Cache miss, running yarn install"
            yarn install --frozen-lockfile
          fi

      - name: Build with Makefile (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        working-directory: kaitu
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        run: |
          echo "üèóÔ∏è Building Kaitu Desktop for macOS..."
          make prepare
          make build-desktop-macos
          echo "üîê Notarizing DMG for macOS..."
          make notarize-dmg

      - name: Build with Makefile (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        working-directory: kaitu
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          echo "üèóÔ∏è Building Kaitu Desktop for Windows..."
          make prepare
          make build-desktop-windows

      - name: List build artifacts
        shell: bash
        working-directory: kaitu
        run: |
          echo "üì¶ Build artifacts in release/${{ steps.get-version.outputs.VERSION }}:"
          ls -la release/${{ steps.get-version.outputs.VERSION }}/ || echo "No files found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kaitu-${{ matrix.name }}-${{ steps.get-version.outputs.VERSION }}
          path: |
            kaitu/release/${{ steps.get-version.outputs.VERSION }}/**/*

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Get version
        id: get-version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-east-1

      - name: Checkout Kaitu repository for scripts
        uses: actions/checkout@v4
        with:
          repository: allnationconnect/kaitu
          ref: v${{ steps.get-version.outputs.VERSION }}
          path: kaitu
          token: ${{ secrets.GH_PAT_TOKEN }}
      
      - name: Setup Node.js for scripts
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Cache Node.js for scripts
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            kaitu/node_modules
          key: ${{ runner.os }}-node-scripts-${{ hashFiles('kaitu/package.json', 'kaitu/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-scripts-

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release files
        run: |
          VERSION="${{ steps.get-version.outputs.VERSION }}"
          mkdir -p release/${VERSION}
          
          # Copy all files from artifacts to release directory
          find artifacts -type f -exec cp {} release/${VERSION}/ \;
          
          echo "üì¶ Release files organized in release/${VERSION}:"
          ls -la release/${VERSION}/

      - name: Generate updater JSON
        run: |
          VERSION="${{ steps.get-version.outputs.VERSION }}"
          echo "üîÑ Generating updater JSON for version ${VERSION}..."
          
          # Copy release directory to kaitu folder since script expects it there
          cp -r release kaitu/
          
          # Run the generate-updater-json.js script
          cd kaitu
          node scripts/generate-updater-json.js ${VERSION}
          
          # Copy all generated *.latest.json files back to our release directory
          cp release/${VERSION}/*.latest.json ../release/${VERSION}/
          
          echo "‚úÖ Updater JSON generated successfully"

      - name: Upload to S3 - Version Directory
        run: |
          VERSION="${{ steps.get-version.outputs.VERSION }}"
          echo "üì§ Uploading release files to S3..."
          
          # Upload all files in the version directory to S3
          aws s3 sync release/${VERSION}/ s3://d.all7.cc/kaitu/desktop/${VERSION}/ \
            --acl public-read \
            --cache-control "public, max-age=3600"
          
          echo "‚úÖ Version ${VERSION} files uploaded to S3"

      - name: Upload to S3 - Latest JSON Files
        run: |
          VERSION="${{ steps.get-version.outputs.VERSION }}"
          echo "üì§ Uploading *.latest.json files to S3 root..."
          
          # Upload all *.latest.json files to the desktop root directory
          for file in release/${VERSION}/*.latest.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" s3://d.all7.cc/kaitu/desktop/${filename} \
                --acl public-read \
                --cache-control "public, max-age=300"
              echo "Uploaded ${filename}"
            fi
          done
          
          
          echo "‚úÖ Latest JSON files uploaded to S3"
          echo "üåê Files available at:"
          echo "   https://d.all7.cc/kaitu/desktop/${VERSION}/"
          echo "   https://d.all7.cc/kaitu/desktop/s3.latest.json"
          echo "   https://d.all7.cc/kaitu/desktop/d0.latest.json" 
          echo "   https://d.all7.cc/kaitu/desktop/jsdelivr.latest.json"

      - name: Create tarball of release directory
        run: |
          VERSION="${{ steps.get-version.outputs.VERSION }}"
          tar -czf kaitu-release-${VERSION}.tar.gz -C release ${VERSION}
          echo "üì¶ Created release tarball: kaitu-release-${VERSION}.tar.gz"
          ls -lh kaitu-release-${VERSION}.tar.gz

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.VERSION }}
          name: Kaitu Release v${{ steps.get-version.outputs.VERSION }}
          body: |
            ## Kaitu Release v${{ steps.get-version.outputs.VERSION }}
            
            ### üì¶ Release Package
            
            This release contains the complete build artifacts for Kaitu Desktop Application.
            
            **Included Platforms:**
            - macOS (Universal, Intel x86_64, Apple Silicon aarch64)
            - Windows (x86_64)
            
            ### üìÅ Package Contents
            
            The release tarball contains the `release/${{ steps.get-version.outputs.VERSION }}/` directory with all platform-specific builds:
            
            **macOS:**
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_universal.dmg` - Universal DMG installer
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_universal.app.tar.gz` - Universal app bundle
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_x86_64.app.tar.gz` - Intel x86_64 app bundle
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_aarch64.app.tar.gz` - Apple Silicon app bundle
            - Signature files (`.sig`) for auto-updater
            
            **Windows:**
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_x64-setup.exe` - NSIS installer
            - `Kaitu_${{ steps.get-version.outputs.VERSION }}_x64_en-US.msi` - MSI installer
            - NSIS update packages (`.nsis.zip`)
            - Signature files (`.sig`) for auto-updater
            
            **Auto-updater:**
            - `s3.latest.json` - Auto-updater configuration for S3 CDN
            - `d0.latest.json` - Auto-updater configuration for d0.all7.cc CDN
            - `jsdelivr.latest.json` - Auto-updater configuration for JSDeliver CDN
            
            ### üöÄ Installation
            
            1. Download the release tarball
            2. Extract: `tar -xzf kaitu-release-${{ steps.get-version.outputs.VERSION }}.tar.gz`
            3. Navigate to `release/${{ steps.get-version.outputs.VERSION }}/`
            4. Install the appropriate package for your platform
            
            ### ‚ú® Features
            - Built with Tauri v2
            - Code-signed and notarized binaries
            - Auto-update support
            - Cross-platform compatibility
            
          files: |
            kaitu-release-${{ steps.get-version.outputs.VERSION }}.tar.gz
            release/${{ steps.get-version.outputs.VERSION }}/*
          draft: false
          prerelease: false